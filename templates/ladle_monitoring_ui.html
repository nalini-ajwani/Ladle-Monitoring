<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ladle Real-Time Monitoring Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f7f7f7;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 1000px;
      margin: auto;
    }
    h2 { text-align: center; }
    label { font-weight: bold; }
    input, select {
      padding: 8px;
      margin: 8px 0 20px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    input[type="text"], input[type="datetime-local"], select {
      width: 20%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th { background-color: #f2f2f2; }
    .button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    .delete-button {
      background-color: red;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ladle Real-Time Monitoring Dashboard</h2>
    <form id="ladleForm">
      <input type="text" id="ladleNo" placeholder="Ladle No" required />
      <select id="process" onchange="toggleLifeInputs()" required>
        <option value="">Select Event</option>
        <option value="Tap">Tap</option>
        <option value="Ready for Tap">Ready for Tap</option>
        <option value="Enter LF (LF1)">Enter LF (LF1)</option>
        <option value="Enter LF (LF2)">Enter LF (LF2)</option>
        <option value="Enter LF (LF3)">Enter LF (LF3)</option>
        <option value="Left LF">Left LF</option>
        <option value="In RH">In RH</option>
        <option value="Left RH">Left RH</option>
        <option value="Enter Caster(CK1)">Enter Caster(CK1)</option>
        <option value="Enter Caster(CK2)">Enter Caster(CK2)</option>
        <option value="Enter Caster(CV1)">Enter Caster(CV1)</option>
        <option value="Enter Caster(CV2)">Enter Caster(CV2)</option>
        <option value="Left Caster">Left Caster</option>
        <option value="In Gas">In Gas</option>
        <option value="Out Gas">Out Gas</option>
        <option value="Ready Gas">Ready Gas</option>
        <option value="Ready Out Gas">Ready Out Gas</option>
        <option value="Down">Down</option>
        <option value="Full Down">Full Down</option>
      </select>
      <div id="lifeInputs" style="display:none;">
        <label for="metalLifeInput">Metal Life:</label>
        <input type="number" id="metalLifeInput" min="0" />
        <label for="slagLifeInput">Slag Life:</label>
        <input type="number" id="slagLifeInput" min="0" />
      </div>
      <input type="datetime-local" id="eventTime" required />
      <input type="text" id="remarks" placeholder="Remarks (optional)" />
      <button class="button" type="button" onclick="submitProcess()">Submit</button>
      <button class="button" type="button" style="background-color:red;" onclick="clearData()">Clear</button>
    </form>
    <table>
      <thead>
        <tr>
          <th>Ladle No</th>
          <th>Current Status</th>
          <th>Since</th>
          <th>Duration</th>
          <th>Total Duration</th>
          <th>Slag Life</th>
          <th>Metal Life</th>
          <th>Remarks</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="dashboard">
        <tr><td colspan="9">No data yet</td></tr>
      </tbody>
    </table>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
const socket = io();
const ladleMap = {};
const tapTimes = {};
let previousLife = { metal: 0, slag: 0 };
const cycleState = {}; // Tracks current stage of each ladle

const sequenceOrder = [
  "Tap", "Enter LF", "Left LF", "In RH", "Left RH", "Enter Caster", "Left Caster"
];
const enterLFGroup = ["Enter LF (LF1)", "Enter LF (LF2)", "Enter LF (LF3)"];
const enterCasterGroup = ["Enter Caster(CK1)", "Enter Caster(CK2)", "Enter Caster(CV1)", "Enter Caster(CV2)"];

const rowColors = {
  "Ready for Tap": "#d4f4dd",
  "Tap": "#d4f4dd",
  "Enter LF (LF1)": "#d4f4dd",
  "Enter LF (LF2)": "#d4f4dd",
  "Enter LF (LF3)": "#d4f4dd",
  "Left LF": "#d4f4dd",
  "In RH": "#d4f4dd",
  "Left RH": "#d4f4dd",
  "Enter Caster(CK1)": "#d4f4dd",
  "Enter Caster(CK2)": "#d4f4dd",
  "Enter Caster(CV1)": "#d4f4dd",
  "Enter Caster(CV2)": "#d4f4dd",
  "Left Caster": "#d4f4dd",
  "Down": "#e0e0e0",
  "Full Down": "#f8d7da",
  "In Gas": "#ffe5b4",
  "Out Gas": "#add8e6",
  "Ready Gas": "#fffacd",
  "Ready Out Gas": "#e6e6fa"
};

function toggleLifeInputs() {
  const process = document.getElementById("process").value;
  document.getElementById("lifeInputs").style.display =
    (process === "Ready Gas") ? "block" : "none";
}

document.getElementById("ladleNo").addEventListener("change", () => {
  let ladleNo = document.getElementById("ladleNo").value.trim();
  if (ladleNo) {
    ladleNo = String(parseInt(ladleNo));
    if (!ladleMap[ladleNo]) {
      previousLife = { metal: 0, slag: 0 };
    }
    if (!cycleState[ladleNo]) {
      cycleState[ladleNo] = "START";
    }
  }
});

function submitProcess() {
  let ladleNo = document.getElementById("ladleNo").value.trim();
  if (!ladleNo) {
    alert("Please enter Ladle No.");
    return;
  }
  ladleNo = String(parseInt(ladleNo));

  const process = document.getElementById("process").value;
  const eventTimeStr = document.getElementById("eventTime").value;
  const remarks = document.getElementById("remarks").value;

  if (!process || !eventTimeStr) {
    alert("Please fill all required fields.");
    return;
  }

  const now = new Date();
  const eventDate = new Date(eventTimeStr);

  if (eventDate > now) {
    alert("Error: Event time cannot be in the future");
    return;
  }

  const lastEvent = ladleMap[ladleNo];
  const state = cycleState[ladleNo] || "START";

  // Enforce cyclic sequence
  if (!validateCycle(state, process, lastEvent)) {
    return;
  }

  // Handle lifecycle counters
  let metalLife = previousLife.metal;
  let slagLife = previousLife.slag;

  if (!lastEvent) {
    if (process === "Tap") {
      metalLife = 0;
      slagLife = 0;
    } else if (process === "Ready Gas") {
      metalLife = parseInt(document.getElementById("metalLifeInput").value || 0);
      slagLife = parseInt(document.getElementById("slagLifeInput").value || 0);
    } else {
      metalLife = 0;
      slagLife = 0;
    }
    previousLife = { metal: metalLife, slag: slagLife };
  } else {
    if (process === "Ready Gas") {
      metalLife = parseInt(document.getElementById("metalLifeInput").value || 0);
      slagLife = parseInt(document.getElementById("slagLifeInput").value || 0);
      previousLife = { metal: metalLife, slag: slagLife };
    } else if (process === "Left Caster") {
      previousLife.metal += 1;
      previousLife.slag += 1;
      metalLife = previousLife.metal;
      slagLife = previousLife.slag;
    } else {
      metalLife = previousLife.metal;
      slagLife = previousLife.slag;
    }
  }

  // Prepare data
  const data = {
    ladleNo,
    process,
    eventTime: eventTimeStr,
    metalLife,
    slagLife,
    remarks
  };

  if (process === "Tap") {
    tapTimes[ladleNo] = eventDate;
  }

  // Update cycle state
  updateCycleState(ladleNo, process);

  socket.emit("new_entry", data);
}

function validateCycle(state, process, lastEvent) {
  if (state === "START") {
    if (process !== "Tap" && process !== "Ready for Tap") {
      alert("Cycle must start with 'Tap' or 'Ready for Tap'.");
      return false;
    }
  }
  if (state === "TAP_DONE") {
    if (!enterLFGroup.includes(process)) {
      alert("After 'Tap', you must select one 'Enter LF' event.");
      return false;
    }
  }
  if (state === "ENTER_LF_DONE") {
    if (process !== "Left LF") {
      alert("After 'Enter LF', you must select 'Left LF'.");
      return false;
    }
  }
  if (state === "LEFT_LF_DONE") {
    if (process === "In RH" || enterCasterGroup.includes(process)) {
      return true;
    } else {
      alert("After 'Left LF', you can select 'In RH' or an 'Enter Caster' event.");
      return false;
    }
  }
  if (state === "IN_RH_DONE") {
    if (process === "Left RH") {
      return true;
    } else {
      alert("After 'In RH', you can select 'Left RH'.");
      return false;
    }
  }
  if (state === "LEFT_RH_DONE") {
    if (enterCasterGroup.includes(process)) {
      return true;
    } else {
      alert("After 'Left RH', you must select an 'Enter Caster' event.");
      return false;
    }
  }
  if (state === "ENTER_CASTER_DONE") {
    if (process === "Left Caster") {
      return true;
    } else {
      alert("After 'Enter Caster', you must select 'Left Caster'.");
      return false;
    }
  }
  return true;
}

function updateCycleState(ladleNo, process) {
  if (!cycleState[ladleNo]) cycleState[ladleNo] = "START";
  let state = cycleState[ladleNo];

  if (process === "Tap" || process === "Ready for Tap") {
    state = "TAP_DONE";
  } else if (enterLFGroup.includes(process)) {
    state = "ENTER_LF_DONE";
  } else if (process === "Left LF") {
    state = "LEFT_LF_DONE";
  } else if (process === "In RH") {
    state = "IN_RH_DONE";
  } else if (process === "Left RH") {
    state = "LEFT_RH_DONE";
  } else if (enterCasterGroup.includes(process)) {
    state = "ENTER_CASTER_DONE";
  } else if (process === "Left Caster") {
    state = "START"; // Cycle completed, reset
  }
  cycleState[ladleNo] = state;
}

function clearData() {
  if (!confirm("Are you sure you want to clear all data?")) return;
  fetch("/clear_data", { method: "POST" }).then(() => {
    document.getElementById("dashboard").innerHTML =
      `<tr><td colspan="9">No data yet</td></tr>`;
    for (let key in ladleMap) delete ladleMap[key];
    for (let key in tapTimes) delete tapTimes[key];
    for (let key in cycleState) delete cycleState[key];
    previousLife = { metal: 0, slag: 0 };
  });
}

function deleteRow(ladleNo) {
  if (!confirm("Are you sure you want to delete this row?")) return;
  socket.emit("delete_entry", { ladleNo });
}

window.onload = () => {
  fetch("/get_data")
    .then((res) => res.json())
    .then((dataArr) => {
      if (!Array.isArray(dataArr) || dataArr.length === 0) return;
      document.getElementById("dashboard").innerHTML = "";
      dataArr.forEach(d => {
        ladleMap[d.ladleNo] = d;
        if (d.process === "Tap") {
          tapTimes[d.ladleNo] = new Date(d.eventTime);
          cycleState[d.ladleNo] = "TAP_DONE";
        }
      });
      renderDashboard();
    });
};

function formatDuration(seconds) {
  if (!isFinite(seconds) || seconds < 0) return "0 sec";
  const days = Math.floor(seconds / (3600 * 24));
  const hours = Math.floor((seconds % (3600 * 24)) / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);

  const parts = [];
  if (days > 0) parts.push(`${days} day${days !== 1 ? 's' : ''}`);
  if (hours > 0) parts.push(`${hours} hr${hours !== 1 ? 's' : ''}`);
  if (minutes > 0) parts.push(`${minutes} min${minutes !== 1 ? 's' : ''}`);
  if (secs > 0 || parts.length === 0) parts.push(`${secs} sec${secs !== 1 ? 's' : ''}`);

  return parts.join(" ");
}

function renderDashboard() {
  const dashboard = document.getElementById("dashboard");
  dashboard.innerHTML = "";
  const now = new Date();

  Object.values(ladleMap).forEach((data) => {
    const eventDate = new Date(data.eventTime);
    const sinceText = eventDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const duration = (now - eventDate) / 1000;
    let totalDuration = 0;
    if (tapTimes[data.ladleNo]) {
      totalDuration = (now - tapTimes[data.ladleNo]) / 1000;
    }

    const color = rowColors[data.process] || "#ffffff";

    const row = `
      <tr style="background-color: ${color}">
        <td>${data.ladleNo}</td>
        <td>${data.process}</td>
        <td>${sinceText}</td>
        <td>${formatDuration(duration)}</td>
        <td>${formatDuration(totalDuration)}</td>
        <td>${data.slagLife}</td>
        <td>${data.metalLife}</td>
        <td>${data.remarks || ""}</td>
        <td><button class="delete-button" onclick="deleteRow('${data.ladleNo}')">Delete</button></td>
      </tr>`;
    dashboard.innerHTML += row;
  });
}
</script>
</body>
</html>
